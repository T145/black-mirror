---
name: Publish Lists

on:
  schedule:
    - cron: "27 13 * * *"
  workflow_dispatch:

jobs:
  build_lists:
    # https://docs.github.com/en/actions/using-github-hosted-runners/using-larger-runners
    # https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#per-minute-rates
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    permissions:
      contents: write

    container:
      image: ghcr.io/t145/black-mirror:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ github.token }}
      options: --user root

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Generate lists
        id: build
        run: |
          chmod -R 755 ./scripts/*
          ./scripts/github/workflow.bash
      - name: Dump output context
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
      # https://github.com/actions/upload-artifact#maintaining-file-permissions-and-case-sensitive-files=
      - name: Archive lists
        if: steps.build.outputs.status == 'success'
        run: tar -cvf lists.tar build/
      - name: Cache lists
        if: steps.build.outputs.status == 'success'
        uses: actions/upload-artifact@v3
        with:
          name: lists
          path: lists.tar
          if-no-files-found: error
          retention-days: 1
      - name: Cache documents
        if: steps.build.outputs.status == 'success'
        uses: actions/upload-artifact@v3
        with:
          name: docs
          path: |
            logs/*
            README.md
          if-no-files-found: error
          retention-days: 1
      - name: Delete lists
        if: always()
        run: rm -rf build/ && rm -f lists.tar
  upload_github:
    runs-on: ubuntu-latest
    needs: build_lists
    continue-on-error: true

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      # https://github.com/actions/download-artifact#limitations=
      - name: Fetch lists
        uses: actions/download-artifact@v3
        with:
          name: lists
      - name: Extract & verify lists
        run: |
          tar -xvf lists.tar
          cd build/
          sha256sum CHECKSUMS.txt
          cd ..
      # https://github.com/softprops/action-gh-release
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: build/*
          generate_release_notes: true
          tag_name: latest
          name: All Artifacts
      - name: Delete lists
        if: always()
        run: rm -rf build/ && rm -f lists.tar
  upload_dropbox:
    runs-on: ubuntu-latest
    needs: build_lists
    continue-on-error: true

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      # https://github.com/actions/download-artifact#limitations=
      - name: Fetch lists
        uses: actions/download-artifact@v3
        with:
          name: lists
      - name: Extract & verify lists
        run: |
          tar -xvf lists.tar
          cd build/
          sha256sum CHECKSUMS.txt
          cd ..
      # The largest list, so we'll just handle this independently
      - name: Upload domain blacklist
        uses: deka0106/upload-to-dropbox@v2
        with:
          dropbox_access_token: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
          src: build/BLOCK_DOMAIN.txt
          dest: /black-mirror/
          mode: overwrite
          multiple: false
      - name: Sleep to avoid 429 error
        run: sleep 5s
      - name: Upload other blacklists
        uses: deka0106/upload-to-dropbox@v2
        with:
          dropbox_access_token: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
          src: |
            build/BLOCK_IPV4.txt
            build/BLOCK_IPV6.txt
            build/BLOCK_CIDR4.txt
            build/BLOCK_CIDR6.txt
          dest: /black-mirror/
          mode: overwrite
          multiple: true
      - name: Sleep to avoid 429 error
        run: sleep 5s
      - name: Upload whitelists and checksums
        uses: deka0106/upload-to-dropbox@v2
        with:
          dropbox_access_token: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
          src: |
            build/WHITE*.txt
            bulid/CHECKSUMS.txt
          dest: /black-mirror/
          mode: overwrite
          multiple: true
      - name: Delete lists
        if: always()
        run: rm -rf build/ && rm -f lists.tar
  delete_build_artifact:
    runs-on: ubuntu-latest
    needs: [upload_github, upload_dropbox]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Delete build artifact
        uses: geekyeggo/delete-artifact@v2
        with:
          name: build
  update_docs:
    runs-on: ubuntu-latest
    needs: upload_github

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Generate changelog
        uses: tj-actions/github-changelog-generator@v1.18
      - name: Fetch documents
        uses: actions/download-artifact@v3
        with:
          name: docs
      - name: Delete docs artifact
        uses: geekyeggo/delete-artifact@v2
        with:
          name: docs
      - name: Make the working tree safe
        run: git config --global --add safe.directory /__w/black-mirror/black-mirror
      - name: Update documents
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          # homage to the python linting utility "black"
          commit_message: "ci(build): ‚ú®üç∞‚ú®"
