name: Publish Lists to GitHub

on:
  workflow_dispatch:
  schedule:
    - cron: "27 1,13 * * *"

jobs:
  github:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/t145/black-mirror:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ github.token }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Make the repo directory safe
        run: git config --global --add safe.directory /__w/black-mirror/black-mirror
        shell: bash

      - name: Generate lists
        id: build
        run: ./scripts/github/workflow.bash
        shell: bash

      - name: Dump build context
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
        shell: bash

      - name: Create GitHub release
        if: steps.build.outputs.status == 'success'
        uses: softprops/action-gh-release@v1
        with:
          # https://docs.github.com/en/actions/security-guides/automatic-token-authentication#using-the-github_token-in-a-workflow
          token: ${{ secrets.FOR_WEBHOOKS_SECRET }}
          draft: false
          prerelease: false
          files: build/*
          name: All Artifacts
          tag_name: latest
          fail_on_unmatched_files: true

      - name: Get release data
        if: steps.build.outputs.status == 'success'
        id: release_data
        uses: KevinRohn/github-full-release-data@v2.0.0
        with:
          token: ${{ secrets.FOR_WEBHOOKS_SECRET }}

      - name: Update changelog
        if: steps.build.outputs.status == 'success'
        uses: stefanzweifel/changelog-updater-action@v1
        with:
          latest-version: latest
          release-notes: ${{ fromJSON(steps.release_data.outputs.body) }}

      - name: Remove local artifacts
        if: always()
        run: rm -rf build/
        shell: bash

      - name: Update the README, CHANGELOG, and logs
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          # homage to the python linting utility "black"
          commit_message: ‚ú®üç∞‚ú®
